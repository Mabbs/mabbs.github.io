---
layout: post
title: å¦‚ä½•ç ´è§£æˆ‘ä¸Šæ¬¡å†™çš„åŠ å¯†ç¨‹åºï¼Ÿ
tags: [Python, åŠ å¯†, ç ´è§£]
---

  ä¸æŒ‰è§„åˆ™ä½¿ç”¨åŠ å¯†ç®—æ³•æ˜¯éå¸¸ä¸å®‰å…¨çš„ï¼<!--more-->    

# èµ·å› 
  å‰å‡ å¤©æˆ‘ç”¨Pythonå†™äº†ä¸€ä¸ª[å¾ˆç®€å•çš„åŠ å¯†ç¨‹åº](/2022/10/08/tinyaes.html)ï¼Œç”¨çš„æ˜¯tinyaesæä¾›çš„AES-128-CTRåŠ å¯†æ–¹å¼ï¼Œç„¶åå› ä¸ºå«Œéº»çƒ¦æ²¡æœ‰æ•´ivã€‚æœ€è¿‘å‡ å¤©æˆ‘ä¸€ç›´åœ¨æœå…³äºAESä¸­å…³äºivçš„ä¿¡æ¯ï¼Œæˆ‘ä¸€ç›´æ²¡æƒ³æ˜ç™½é‚£ä¸ªivåˆ°åº•æ˜¯å¹²å•¥ç”¨çš„ã€‚   
  åœ¨æˆ‘çœ‹äº†å‡ å¤©é‚£äº›å…³äºAESçš„5ç§åŠ å¯†æ¨¡å¼ä¹‹åï¼Œå…³äºECBå’ŒCBCçš„åŠ å¯†æ¨¡å¼è®²çš„å¾ˆå¤šï¼Œè€Œå¯¹å…¶ä»–åŠ å¯†æ¨¡å¼è®²çš„å¾ˆä¸æ¸…æ¥šâ€¦â€¦ä½†å”¯ä¸€å†™çš„å¾ˆæ¸…æ¥šçš„å°±æ˜¯ECBå¾ˆä¸å®‰å…¨ï¼Œé‡å¤ä½¿ç”¨ç›¸åŒçš„å¯†é’¥å’ŒivåŠ å¯†æ•°æ®å¾ˆä¸å®‰å…¨ï¼Œå°¤å…¶æ˜¯CTRæ¨¡å¼ï¼Œç›´æ¥å®Œå…¨ä¸§å¤±äº†æœºå¯†æ€§ğŸ˜‚ï¼Œè¿™ä¸æ˜¯åœ¨å®Œå…¨å¦å®šæˆ‘å‰å‡ å¤©å†™çš„ä¸œè¥¿å˜›ï¼Œç„¶è€Œé™¤äº†è¿™äº›å°±å†æ²¡æœ‰å†™åˆ«çš„äº†â€¦â€¦é‚£å®ƒåˆ°åº•æ˜¯æ€ä¹ˆä¸ªä¸§å¤±äº†æœºå¯†æ€§å•Šï¼Œåˆä¸è¯´æ¸…æ¥šï¼Œæ‰€ä»¥å°±åªå¥½æˆ‘è‡ªå·±æƒ³äº†ğŸ˜“ã€‚

# æ¢ç´¢
  é¦–å…ˆæˆ‘å…ˆçœ‹äº†çœ‹AESä¸­5ç§åŠ å¯†æ¨¡å¼çš„åŒºåˆ«ï¼Œå‘ç°CTRæ¨¡å¼å’Œå…¶ä»–æ¨¡å¼æœ‰ä¸ªä¸åŒçš„åœ°æ–¹æ˜¯å®ƒåŠ å¯†çš„æ˜¯å¯†ç ï¼Œè€Œä¸æ˜¯æ•°æ®ï¼Œå®ƒæ˜¯æŠŠå¯†ç å’Œivé€šè¿‡AESåŠ å¯†ç®—æ³•åŠ å¯†ä¹‹åæŠŠè·å¾—çš„ä¸œè¥¿å’Œæ˜æ–‡æ•°æ®å¼‚æˆ–åæ¥å¾—åˆ°å¯†æ–‡çš„ï¼Œæ€ªä¸å¾—å®ƒå¯ä»¥åŠ å¯†å’Œè§£å¯†ç”¨ç›¸åŒçš„æ–¹æ³•ï¼ŒåŸæ¥å®ƒçœŸçš„å°±æ˜¯å¼‚æˆ–åŠ å¯†å•ŠğŸ˜‚ï¼Œé‚£å¼‚æˆ–åŠ å¯†å®‰å…¨å—ï¼Ÿæˆ‘åœ¨ç½‘ä¸Šä¹Ÿæœäº†æœï¼Œå¾ˆå¤šäººè¯´è¿™æ˜¯ä¸€ç§éå¸¸ä¸å®‰å…¨çš„åŠ å¯†æ–¹å¼ï¼Œåªæœ‰ä¸æ‡‚çš„äººå’Œåˆšå…¥é—¨å¯†ç å­¦çš„äººæ‰ä¼šç”¨ï¼Œå·§äº†ï¼Œæˆ‘å°±æ˜¯ä¸æ‡‚å¯†ç å­¦çš„äººğŸ˜‚ï¼Œç„¶è€Œå¼‚æˆ–åŠ å¯†åˆæ€ä¹ˆä¸å®‰å…¨ç½‘ä¸Šåˆä¸è¯´â€¦â€¦æˆ‘çœŸçš„æ˜¯æ— è¯­äº†ã€‚   
  ä¸è¯´æˆ‘å°±åªèƒ½è‡ªå·±æƒ³äº†â€¦â€¦é¦–å…ˆï¼Œä»–ä»¬è¯´CTRä¸å®‰å…¨çš„åŠ å¯†ä»…é™äºç›¸åŒçš„ivå’Œå¯†ç å»åŠ å¯†ä¸åŒçš„æ•°æ®ï¼Œè€ŒåŠ å¯†çš„æ–¹å¼æ˜¯é€šè¿‡å¼‚æˆ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆè¿™æ ·å»ç®—ä¸€ä¸‹ï¼š   
  K = AES(key, iv)   
  C1 = K xor P1  
  C2 = K xor P2  
  å…¶ä¸­Kæ˜¯ç”¨AESåŠ å¯†å¯†ç å’Œivè·å¾—çš„å€¼ï¼ŒCä»£è¡¨å¯†æ–‡ï¼ŒPä»£è¡¨æ˜æ–‡ã€‚ç„¶åæƒ³ç€æƒ³ç€ï¼Œå¦‚æœç”¨C1 xor C2ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿæœ€ç»ˆç”¨å¼‚æˆ–è¿ç®—å¾‹ç®—äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚æ˜ç™½äº†ä¸ºä»€ä¹ˆå®ƒä¸å®‰å…¨äº†ï¼Œå› ä¸ºï¼š   
  C1 xor C2 = P1 xor P2   
  æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å‡å¦‚ä½ ç”¨P1æˆ–P2å»å¼‚æˆ–ä¸Šé¢å¼å­å¾—åˆ°çš„å€¼ï¼Œé‚£ä½ å°±èƒ½å¾—åˆ°å¦ä¸€ä¸ªæ˜æ–‡ï¼Œä¹Ÿå°±æ˜¯ï¼š   
  (C1 xor C2) xor P1 = P2   
  è¿™æ ·ä½ åªè¦çŸ¥é“ä¸€ç»„ç”¨è¿™ä¸ªå¯†é’¥åŠ å¯†çš„å¯†æ–‡å’Œæ˜æ–‡ï¼Œå°±èƒ½ç ´è§£æ‰€æœ‰å…¶ä»–å¯†æ–‡äº†ï¼   
  äºæ˜¯æ ¹æ®è¿™ä¸ªåŸç†æˆ‘è¯•ç€ç”¨Pythonå†™äº†ä¸€ä¸ªæ ¹æ®å·²çŸ¥æ˜æ–‡å¯†æ–‡å¯¹è·å¾—å¯†æ–‡çš„ç¨‹åºå‡ºæ¥ï¼š
```python
import sys

if not len(sys.argv) == 4:
    exit(f"Usage: {sys.argv[0]} [enc_file1] [enc_file2] [plain_file2]")
with open(sys.argv[1], "rb") as enc_file1:
    with open(sys.argv[2], "rb") as enc_file2:
        with open(sys.argv[3], "rb") as plain_file2:
            with open(sys.argv[1] + ".crack", "wb") as crack_file1:
                crack_file1.write(bytes(a ^ b for (a, b) in zip(bytes(a ^ b for (a, b) in zip(enc_file1.read(), enc_file2.read())), plain_file2.read())))
```
  å†™å®Œä¹‹åå‘ç°å’ŒåŠ å¯†çš„ç¨‹åºç”¨äº†ä¸€æ ·å¤šçš„è¡Œæ•°ğŸ˜‚ï¼Œè¯•äº†ä¸€ä¸‹ï¼ŒçœŸçš„å¯ä»¥è·å¾—å¦å¤–å¯†æ–‡çš„å¯¹åº”çš„æ˜æ–‡ï¼è€Œä¸”æ˜¯åœ¨ä¸éœ€è¦çŸ¥é“å¯†ç çš„æƒ…å†µï¼Œä¸è¿‡æˆ‘ä¸çŸ¥é“æ˜¯æˆ‘ç¨‹åºå†™çš„æœ‰é—®é¢˜è¿˜æ˜¯æ¨ç®—çš„æœ‰é—®é¢˜ï¼Œå½“æƒ³è¦ç ´è§£çš„æ–‡ä»¶é•¿åº¦æ¯”å·²çŸ¥æ˜æ–‡å¯†æ–‡çš„æ–‡ä»¶é•¿æ—¶ï¼Œç ´è§£å‡ºæ¥çš„æ˜æ–‡å°±åªèƒ½ç ´è§£åˆ°å’Œå·²çŸ¥æ˜æ–‡å¯†æ–‡ä¸€æ ·é•¿çš„ä½ç½®â€¦â€¦æ€»ä¹‹èƒ½è¯æ˜ä¹‹å‰å†™çš„åŠ å¯†ç¡®å®â€œå®Œå…¨ä¸§å¤±äº†æœºå¯†æ€§â€å°±è¡Œäº†ã€‚   

# è§£å†³åŠæ³•
  ä¸ºäº†å¼¥è¡¥ä¸Šä¸€ç¯‡æ–‡ç« å†™çš„åŠ å¯†ç¨‹åºæ‰€é‡åˆ°çš„é—®é¢˜ï¼Œè¿™æ¬¡æˆ‘è¿˜æ˜¯ä¹–ä¹–çš„æŒ‰ç…§å®˜æ–¹è¯´æ˜ä½¿ç”¨ivå§ï¼Œæ ¹æ®è¿™ä¸ªåŸç†æˆ‘é‡æ–°å†™äº†ä¸€ä¸‹æˆ‘çš„ç¨‹åºï¼š
```python
import hashlib, tinyaes, sys, os

if not len(sys.argv) == 3:
    exit(f"Usage: {sys.argv[0]} [filepath] [key]")
enc = False
if len(sys.argv[1]) > 4:
    if sys.argv[1][-4:] == ".enc":
        enc = True
with open(sys.argv[1], 'rb') as orig:
    iv = os.urandom(16)
    key = tinyaes.AES(hashlib.md5(sys.argv[2].encode()).digest(), orig.read(16) if enc else iv)
    with open(sys.argv[1][:-4] if enc else sys.argv[1] + ".enc", 'wb') as targetfile:
        if not enc:
            targetfile.write(iv)
        for byte_block in iter(lambda: orig.read(4096), b''):
            targetfile.write(key.CTR_xcrypt_buffer(byte_block))
```
  è¿™æ¬¡æˆ‘æŠŠéšæœºç”Ÿæˆçš„ivå­˜åˆ°äº†æ–‡ä»¶çš„å¼€å¤´ï¼Œä¸è¿‡ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œæˆ‘æ²¡åŠæ³•ç”¨å®Œå…¨ç›¸åŒçš„åŠæ³•å»è¿›è¡ŒåŠ å¯†å’Œè§£å¯†äº†â€¦â€¦æ‰€ä»¥ç”¨äº†`.enc`åç¼€åä½œä¸ºæ˜æ–‡å’Œå¯†æ–‡çš„åŒºåˆ†ã€‚è¿˜æœ‰ç¨‹åºçš„è¡Œæ•°å‡ ä¹å¢åŠ äº†ä¸€å€ğŸ˜‚ã€‚   

# æ„Ÿæƒ³
  çœ‹æ¥å¯¹äºä¸å¤ªäº†è§£çš„å­¦ç§‘è¿˜æ˜¯å¥½å¥½çš„æŒ‰ç…§äººå®¶è¯´æ˜ä¹¦ä¸Šå†™çš„åšæ¯”è¾ƒå¥½ï¼Œä¸ç„¶ä¸æ‡‚è£…æ‡‚å°±ä¼šè¾¾ä¸åˆ°é¢„æœŸçš„æƒ³æ³•äº†ã€‚
